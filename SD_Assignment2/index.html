<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Week 7 - Part 4_1</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
    <style type="text/css">

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

    </style>
</head>
<body>

<p>Click on this text to update the chart with new data values as many times as you like!</p>

<script type="text/javascript">

    var w = 500;
    var h = 300;
    var padding = 30;
    var xScale;
    var yScale;
    var dataset;
    var svg;
    var data2015;
    var data2003;

    //Define X axis
    var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom")
            .ticks(5);

    //Define Y axis
    var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left")
            .ticks(5);

    d3.csv("week7_part4_1.csv", function (error, data) {

        if (error) {  //If error is not null, something went wrong.
            console.log("Error: " + error);  //Log the error.
        } else {      //If no error, the file loaded correctly. Yay!

            var dataCategorized = d3.nest()
                    .key(function(d) { return d.year})
                    .key(function(d) { return d.district; })
                    .key(function(d) { return d.category; })
                    .rollup(function(v) { return v.length; })
                    .map(data);

            data2015 = dataCategorized['2015']
            data2003 = dataCategorized['2003']
            dataset = data2015;
            console.log(dataset)
            create_scale_functions();
            create_svg();
            //create_axis();
        }

    });

    function create_scale_functions() {
        xScale = d3.scale.linear()
                .domain([0, d3.max(dataset, function (d, i) {
                    console.log('scale')
                    console.log(d)
                    return dataset[i]['PROSTITUTION'];
                })])
                .range([padding, w - padding * 2]);

        yScale = d3.scale.linear()
                .domain([0, d3.max(dataset, function (d, i) {
                    return dataset[i]['VEHICLE THEFT'];
                })])
                .range([h - padding, padding]);
    }

    function create_svg() {
        //Create SVG element
        svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

        console.log("bla")
        //Create circles
        svg.selectAll("circle")
                .data(dataset)
                .enter()
                .append("circle")
                .attr("cx", function (d, i) {
                    console.log(d)
                    console.log(i)
                    return xScale(dataset[i]);
                })
                .attr("cy", function (d, i) {
                    console.log(d)
                    return yScale(dataset[i]);
                })
                .attr("r", 2);
        console.log("bla2")
    }

    function create_axis() {
        console.log("bla3")
        console.log(xAxis)
        //Create X axis
        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xAxis);

        console.log("bla4")
        //Create Y axis
        svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(yAxis);

        console.log("bla5")
    }



    //On click, update with new data
    d3.select("p")
            .on("click", function () {

                //New values for dataset
                var numValues = dataset.length;						 		//Count original length of dataset
                var maxRange = Math.random() * 1000;						//Max range of new values
                dataset = [];  						 				 		//Initialize empty array
                for (var i = 0; i < numValues; i++) {				 		//Loop numValues times
                    var newNumber1 = Math.floor(Math.random() * maxRange);	//New random integer
                    var newNumber2 = Math.floor(Math.random() * maxRange);	//New random integer
                    dataset.push([newNumber1, newNumber2]);					//Add new number to array
                }

                //Update scale domains
                xScale.domain([0, d3.max(dataset, function (d) {
                    return d[0];
                })]);
                yScale.domain([0, d3.max(dataset, function (d) {
                    return d[1];
                })]);

                //Update all circles
                svg.selectAll("circle")
                        .data(dataset)
                        .transition()
                        .duration(1000)
                        .each("start", function () {
                            d3.select(this)
                                    .attr("fill", "magenta")
                                    .attr("r", 3);
                        })
                        .attr("cx", function (d) {
                            return xScale(d[0]);
                        })
                        .attr("cy", function (d) {
                            return yScale(d[1]);
                        })
                        .each("end", function () {
                            d3.select(this)
                                    .attr("fill", "black")
                                    .attr("r", 2);
                        });

                //Update X axis
                svg.select(".x.axis")
                        .transition()
                        .duration(1000)
                        .call(xAxis);

                //Update Y axis
                svg.select(".y.axis")
                        .transition()
                        .duration(1000)
                        .call(yAxis);

            });


</script>
</body>
</html>